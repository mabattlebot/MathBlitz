import React, { useEffect, useMemo, useRef, useState } from "react";

// Fast Math Blitz — Complete, fixed version
// - All generators included
// - LEVELS defined before use
// - Corrected HighScores JSX (no unterminated tags)
// - Post-game solution review for missed problems

// ---------- Utility helpers ----------
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
const roundTo = (x, d = 2) => {
  const p = Math.pow(10, d);
  return Math.round(x * p) / p;
};

const withinTol = (user, correct, tol = 0.02) => {
  if (typeof correct === "number") {
    const u = Number(user);
    if (Number.isNaN(u)) return false;
    return Math.abs(u - correct) <= Math.max(tol, Math.abs(correct) * tol);
  }
  return String(user).trim().toLowerCase() === String(correct).trim().toLowerCase();
};

// ---------- Question Generators ----------
const genBelow = () => {
  const type = pick(["add", "sub", "mul", "div", "percent", "decimal", "power2", "sqrt"]);
  switch (type) {
    case "add": {
      const a = randInt(5, 99), b = randInt(5, 99);
      return { prompt: `${a} + ${b} = ?`, answer: a + b };
    }
    case "sub": {
      let a = randInt(20, 120), b = randInt(5, 60);
      if (b > a) [a, b] = [b, a];
      return { prompt: `${a} − ${b} = ?`, answer: a - b };
    }
    case "mul": {
      const a = randInt(3, 15), b = randInt(3, 15);
      return { prompt: `${a} × ${b} = ?`, answer: a * b };
    }
    case "div": {
      const b = randInt(2, 12), q = randInt(2, 12);
      const a = b * q;
      return { prompt: `${a} ÷ ${b} = ?`, answer: q };
    }
    case "percent": {
      const base = randInt(50, 400);
      const p = pick([5, 10, 12.5, 15, 20, 25, 30, 40, 50]);
      const val = roundTo((p / 100) * base, 2);
      return { prompt: `${p}% of ${base} = ? (decimal)`, answer: val };
    }
    case "decimal": {
      const a = roundTo(randInt(50, 999) / 10, 1);
      const b = roundTo(randInt(50, 999) / 10, 1);
      return { prompt: `${a} + ${b} = ?`, answer: roundTo(a + b, 2) };
    }
    case "power2": {
      const a = randInt(5, 25);
      return { prompt: `${a}² = ?`, answer: a * a };
    }
    case "sqrt": {
      const a = pick([4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169]);
      return { prompt: `√${a} = ?`, answer: Math.sqrt(a) };
    }
    default:
      return { prompt: "2 + 2 = ?", answer: 4 };
  }
};

const genHS1 = () => {
  const type = pick(["linear", "slope", "exp"]);
  if (type === "linear") {
    const a = pick([2, 3, 4, 5, 6]);
    const x = randInt(-8, 8);
    const b = randInt(-10, 10);
    const c = a * x + b;
    return { prompt: `Solve: ${a}x + ${b} = ${c}. What is x?`, answer: x };
  }
  if (type === "slope") {
    const x1 = randInt(-6, 6), x2 = randInt(-6, 6);
    const m = pick([-3, -2, -1, 1, 2, 3]);
    const y1 = randInt(-5, 5);
    const y2 = y1 + m * (x2 - x1);
    return { prompt: `Slope between (${x1}, ${y1}) and (${x2}, ${y2}) = ?`, answer: m };
  }
  const m = randInt(1, 6), n = randInt(1, 6);
  return { prompt: `In a^${m} · a^${n}, what is the new exponent?`, answer: m + n };
};

const genHS2 = () => {
  const type = pick(["quad_roots", "discriminant", "rad"]);
  if (type === "quad_roots") {
    const r1 = randInt(-6, 6), r2 = randInt(-6, 6);
    const b = -(r1 + r2);
    const c = r1 * r2;
    return pick([
      { prompt: `For x^2 + (${b})x + (${c}) = 0, what is r1 + r2?`, answer: -b },
      { prompt: `For x^2 + (${b})x + (${c}) = 0, what is r1·r2?`, answer: c },
    ]);
  }
  if (type === "discriminant") {
    const a = pick([1, 1, 2, 3]);
    const b = randInt(-8, 8);
    const c = randInt(-10, 10);
    return { prompt: `Discriminant of ${a}x^2 + ${b}x + ${c} = ?`, answer: b * b - 4 * a * c };
  }
  const m = pick([1, 2, 3, 5, 7, 8, 12, 18, 20, 27, 32]);
  const n = pick([1, 2, 4, 5, 8, 9, 16]);
  const val = roundTo(Math.sqrt(m / n), 3);
  return { prompt: `Evaluate √(${m}/${n}) (decimal)`, answer: val };
};

const genHS3 = () => {
  const type = pick(["poly_eval", "exp_eval", "trig"]);
  if (type === "poly_eval") {
    const a = randInt(-3, 3) || 2;
    const b = randInt(-5, 5);
    const c = randInt(-6, 6);
    const x = randInt(-4, 4);
    const val = a * x * x + b * x + c;
    return { prompt: `If f(x) = ${a}x^2 + ${b}x + ${c}, compute f(${x}).`, answer: val };
  }
  if (type === "exp_eval") {
    const a = pick([2, 3, 5, 10]);
    const k = pick([-2, -1, 1, 2]);
    const x = randInt(1, 4);
    const val = Math.pow(a, k * x);
    return { prompt: `Evaluate ${a}^(${k}·${x}).`, answer: val };
  }
  const angle = pick([0, 30, 45, 60, 90]);
  const fn = pick(["sin", "cos", "tan"]);
  if (fn === "tan" && angle === 90) return genHS3();
  const rad = (angle * Math.PI) / 180;
  let v = 0;
  if (fn === "sin") v = Math.sin(rad);
  if (fn === "cos") v = Math.cos(rad);
  if (fn === "tan") v = Math.tan(rad);
  return { prompt: `Evaluate ${fn}(${angle}°) (decimal)`, answer: roundTo(v, 3) };
};

const genPrecalc = () => {
  const type = pick(["unit", "i_pow", "nCr"]);
  if (type === "unit") {
    const angle = pick([0, 30, 45, 60, 90, 120, 135, 150, 180]);
    const fn = pick(["sin", "cos"]);
    const rad = (angle * Math.PI) / 180;
    const val = fn === "sin" ? Math.sin(rad) : Math.cos(rad);
    return { prompt: `Evaluate ${fn}(${angle}°) (decimal)`, answer: roundTo(val, 3) };
  }
  if (type === "i_pow") {
    const n = randInt(0, 25);
    const cycle = ["1", "i", "-1", "-i"][n % 4];
    return { prompt: `Compute i^${n}. Answer using 1, -1, i, or -i.`, answer: cycle };
  }
  const n = randInt(4, 9);
  const r = randInt(0, n);
  const nCr = (n, r) => {
    if (r < 0 || r > n) return 0;
    r = Math.min(r, n - r);
    let num = 1, den = 1;
    for (let k = 1; k <= r; k++) {
      num *= n - r + k;
      den *= k;
    }
    return Math.round(num / den);
  };
  return { prompt: `Compute C(${n}, ${r}).`, answer: nCr(n, r) };
};

const genCalculus = () => {
  const type = pick(["poly_deriv_at", "sin_deriv_at", "exp_deriv_at", "poly_integral_0m"]);
  if (type === "poly_deriv_at") {
    const n = randInt(2, 6);
    const a = randInt(-4, 4) || 3;
    const x = randInt(-3, 3);
    const val = a * n * Math.pow(x, n - 1);
    return { prompt: `If f(x)=${a}x^${n}, compute f'(${x}).`, answer: val };
  }
  if (type === "sin_deriv_at") {
    const k = pick([1, 2, 3, 4]);
    const x = pick([0, Math.PI / 6, Math.PI / 4, Math.PI / 3, Math.PI / 2]);
    const val = k * Math.cos(k * x);
    const map = new Map([
      [0, "0"],
      [Math.PI / 6, "π/6"],
      [Math.PI / 4, "π/4"],
      [Math.PI / 3, "π/3"],
      [Math.PI / 2, "π/2"],
    ]);
    const label = map.get(x) || String(x);
    return { prompt: `If f(x)=sin(${k}x), compute f'(${label}). (decimal)`, answer: roundTo(val, 3) };
  }
  if (type === "exp_deriv_at") {
    const a = pick([Math.E, 2, 3]);
    const x = randInt(-2, 2);
    const val = a === Math.E ? Math.exp(x) : Math.pow(a, x) * Math.log(a);
    const baseStr = a === Math.E ? "e" : `${a}`;
    return { prompt: `If f(x)=${baseStr}^x, compute f'(${x}). (decimal)`, answer: roundTo(val, 3) };
  }
  const a = randInt(1, 6);
  const n = randInt(1, 5);
  const m = randInt(1, 4);
  const val = (a * Math.pow(m, n + 1)) / (n + 1);
  return { prompt: `Compute ∫₀^${m} ${a}x^${n} dx.`, answer: roundTo(val, 3) };
};

// ---------- LEVELS ----------
const LEVELS = [
  { id: "below", name: "Everything Below", gen: genBelow },
  { id: "hs1", name: "HS Math 1", gen: genHS1 },
  { id: "hs2", name: "HS Math 2", gen: genHS2 },
  { id: "hs3", name: "HS Math 3", gen: genHS3 },
  { id: "precalc", name: "Precalculus", gen: genPrecalc },
  { id: "calc", name: "Calculus", gen: genCalculus },
];

// ---------- Local High Scores ----------
const HS_KEY = "fast-math-blitz-hs";
function getHighScores() {
  try {
    const raw = typeof localStorage !== "undefined" ? localStorage.getItem(HS_KEY) : null;
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}
function saveHighScore(level, score, accuracy) {
  try {
    const now = new Date().toISOString();
    const entry = { level, score, accuracy, at: now };
    const arr = getHighScores();
    arr.push(entry);
    arr.sort((a, b) => b.score - a.score || (b.accuracy || 0) - (a.accuracy || 0));
    const trimmed = arr.slice(0, 20);
    if (typeof localStorage !== "undefined") localStorage.setItem(HS_KEY, JSON.stringify(trimmed));
  } catch (e) {
    console.warn("saveHighScore failed", e);
  }
}
function resetHighScores() {
  try {
    if (typeof localStorage !== "undefined") localStorage.removeItem(HS_KEY);
    if (typeof window !== "undefined" && window.location && window.location.reload) window.location.reload();
  } catch (e) {
    console.warn(e);
  }
}

// ---------- App ----------
export default function App() {
  const [level, setLevel] = useState(LEVELS[0].id);
  const [playing, setPlaying] = useState(false);
  const [timeLeft, setTimeLeft] = useState(60);
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);
  const [hearts, setHearts] = useState(3);
  const [question, setQuestion] = useState({ prompt: "", answer: 0 });
  const [input, setInput] = useState("");
  const [flash, setFlash] = useState("");
  const [history, setHistory] = useState([]); // {q,a,u,ok}
  const [correctCount, setCorrectCount] = useState(0);
  const [attempts, setAttempts] = useState(0);
  const [showSolutions, setShowSolutions] = useState(false);
  const inputRef = useRef(null);

  const currentLevel = useMemo(() => LEVELS.find((l) => l.id === level) || LEVELS[0], [level]);

  useEffect(() => {
    if (!playing) return;
    if (timeLeft <= 0 || hearts <= 0) {
      endGame();
      return;
    }
    const t = setTimeout(() => setTimeLeft((t) => t - 1), 1000);
    return () => clearTimeout(t);
  }, [playing, timeLeft, hearts]);

  useEffect(() => {
    if (playing && inputRef.current) inputRef.current.focus();
  }, [playing, question]);

  const nextQuestion = () => {
    const q = currentLevel.gen();
    setQuestion(q);
    setInput("");
  };

  const startGame = () => {
    setPlaying(true);
    setTimeLeft(60);
    setScore(0);
    setStreak(0);
    setHearts(3);
    setHistory([]);
    setCorrectCount(0);
    setAttempts(0);
    setShowSolutions(false);
    nextQuestion();
  };

  const endGame = () => {
    setPlaying(false);
    const accuracy = attempts > 0 ? roundTo((correctCount / attempts) * 100, 1) : 0;
    saveHighScore(level, score, accuracy);
    setShowSolutions(true);
  };

  const basePoints = 100;
  const multiplier = 1 + Math.floor(streak / 3) * 0.25;

  const submit = () => {
    if (!playing) return;
    const ok = withinTol(input, question.answer);
    setHistory((h) => [{ q: question.prompt, a: question.answer, u: input, ok }, ...h].slice(0, 10));
    setAttempts((a) => a + 1);
    if (ok) {
      setCorrectCount((c) => c + 1);
      const pts = Math.round(basePoints * multiplier);
      setScore((s) => s + pts);
      setStreak((k) => k + 1);
      setFlash("good");
      setTimeout(() => setFlash(""), 120);
      nextQuestion();
    } else {
      setHearts((h) => h - 1);
      setStreak(0);
      setFlash("bad");
      setTimeout(() => setFlash(""), 180);
    }
  };

  const onKeyDown = (e) => {
    if (e.key === "Enter") submit();
  };

  const accuracy = attempts > 0 ? roundTo((correctCount / attempts) * 100, 1) : 0;

  return (
    <div className="min-h-screen w-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-50 flex items-center justify-center p-4">
      <div className="w-full max-w-3xl">
        <header className="flex items-center justify-between mb-4">
          <h1 className="text-3xl font-bold tracking-tight">⚡ Fast Math Blitz</h1>
          <a
            className="text-xs opacity-70 hover:opacity-100"
            href="#"
            onClick={(e) => {
              e.preventDefault();
              resetHighScores();
            }}
            title="Reset local highscores"
          >
            Reset High Scores
          </a>
        </header>

        {!playing ? (
          <StartScreen level={level} setLevel={setLevel} startGame={startGame} />
        ) : (
          <GameScreen
            levelName={currentLevel.name}
            timeLeft={timeLeft}
            score={score}
            multiplier={multiplier}
            streak={streak}
            hearts={hearts}
            question={question}
            input={input}
            setInput={setInput}
            inputRef={inputRef}
            flash={flash}
            onSubmit={submit}
            onKeyDown={onKeyDown}
            accuracy={accuracy}
          />
        )}

        {!playing && getHighScores().length > 0 && <HighScores />}

        {!playing && history.length > 0 && (
          <SummaryCard history={history} score={score} accuracy={accuracy} showSolutions={showSolutions} />
        )}
      </div>
    </div>
  );
}

// ---------- UI components ----------
function StartScreen({ level, setLevel, startGame }) {
  return (
    <div className="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 shadow-xl">
      <p className="text-sm opacity-80 mb-3">
        Pick a level and smash as many correct answers as you can in 60 seconds. You get 3 hearts.
        Build streaks to unlock point multipliers. Go fast, stay accurate.
      </p>
      <label className="block text-sm mb-2">Select level</label>
      <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
        {LEVELS.map((lvl) => (
          <button
            key={lvl.id}
            onClick={() => setLevel(lvl.id)}
            className={`rounded-xl border px-3 py-2 text-left transition transform active:scale-95 ${
              level === lvl.id
                ? "bg-emerald-500 text-slate-900 border-emerald-400"
                : "bg-slate-900/60 border-slate-700 hover:border-slate-600"
            }`}
          >
            <div className="text-sm font-semibold">{lvl.name}</div>
            <div className="text-xs opacity-70">Randomized questions</div>
          </button>
        ))}
      </div>
      <button
        onClick={startGame}
        className="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold py-3 rounded-2xl shadow-lg shadow-emerald-500/20"
      >
        Start 60s Blitz
      </button>
    </div>
  );
}

function GameScreen({
  levelName,
  timeLeft,
  score,
  multiplier,
  streak,
  hearts,
  question,
  input,
  setInput,
  inputRef,
  flash,
  onSubmit,
  onKeyDown,
  accuracy,
}) {
  return (
    <div className="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 shadow-xl">
      <div className="flex items-center justify-between mb-4">
        <div className="text-sm opacity-80">{levelName}</div>
        <div className="flex items-center gap-3">
          <Timer timeLeft={timeLeft} />
          <Score score={score} multiplier={multiplier} accuracy={accuracy} />
          <Hearts hearts={hearts} />
        </div>
      </div>

      <div className={`text-center rounded-2xl py-8 px-4 mb-4 border ${
        flash === "good"
          ? "bg-emerald-600/20 border-emerald-400"
          : flash === "bad"
          ? "bg-rose-600/20 border-rose-400"
          : "bg-slate-900/40 border-slate-700"
      }`}>
        <div className="text-sm opacity-70 mb-1">Question</div>
        <div className="text-2xl font-bold tracking-tight select-none">{question.prompt}</div>
      </div>

      <div className="flex gap-2 mb-3">
        <input
          ref={inputRef}
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={onKeyDown}
          placeholder="Type answer…"
          className="flex-1 bg-slate-900/60 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-400"
          autoFocus
        />
        <button
          onClick={onSubmit}
          className="px-4 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold"
        >
          Submit
        </button>
      </div>

      <div className="flex items-center justify-between text-sm">
        <div>
          Streak: <span className="font-semibold">{streak}</span>
        </div>
        <div className="opacity-80">Multiplier: ×{roundTo(multiplier, 2)}</div>
      </div>
    </div>
  );
}

function Timer({ timeLeft }) {
  const pct = clamp((timeLeft / 60) * 100, 0, 100);
  return (
    <div className="w-32">
      <div className="text-xs mb-1 text-center opacity-70">Time</div>
      <div className="h-2 rounded-full bg-slate-700 overflow-hidden">
        <div className="h-2 bg-emerald-500 transition-all" style={{ width: `${pct}%` }} />
      </div>
      <div className="text-center text-sm mt-1 font-semibold">{timeLeft}s</div>
    </div>
  );
}

function Score({ score, multiplier, accuracy }) {
  return (
    <div className="text-right">
      <div className="text-xs mb-1 opacity-70">Score</div>
      <div className="text-xl font-bold leading-none">{score}</div>
      <div className="text-xs opacity-70">x{roundTo(multiplier, 2)}</div>
      <div className="text-xs opacity-70">Acc: {accuracy}%</div>
    </div>
  );
}

function Hearts({ hearts }) {
  const icons = Array.from({ length: 3 }, (_, i) => (
    <span key={i} className={i < hearts ? "opacity-100" : "opacity-30"}>
      ❤️
    </span>
  ));
  return (
    <div className="text-right w-20">
      <div className="text-xs mb-1 opacity-70">Hearts</div>
      <div className="text-lg tracking-widest">{icons}</div>
    </div>
  );
}

function SummaryCard({ history, score, accuracy, showSolutions }) {
  return (
    <div className="mt-4 bg-slate-800/60 border border-slate-700 rounded-2xl p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="font-semibold">Last 10</div>
        <div className="text-sm opacity-80">Final score: {score} | Accuracy: {accuracy}%</div>
      </div>
      <ul className="space-y-2 text-sm max-h-64 overflow-auto pr-2">
        {history.map((h, i) => (
          <li
            key={i}
            className={`p-2 rounded ${h.ok ? "bg-emerald-900/20" : "bg-rose-900/20"}`}
          >
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div className="flex-1 truncate font-medium">{h.q}</div>
              <div className="opacity-80">Your: <span className="font-semibold">{String(h.u)}</span></div>
              <div className="opacity-70">Correct: <span className="font-semibold">{String(h.a)}</span></div>
            </div>
            {!h.ok && showSolutions && (
              <div className="text-xs opacity-70 mt-2">Solution hint: The correct process leads to <strong>{String(h.a)}</strong>. Try reversing the steps from the question (example: isolate x, simplify fractions, use trig identities).</div>
            )}
            <div className="text-sm mt-1">{h.ok ? <span className="text-emerald-300">✓</span> : <span className="text-rose-300">✗</span>}</div>
          </li>
        ))}
      </ul>
    </div>
  );
}

function HighScores() {
  const all = getHighScores();
  return (
    <div className="mt-4 bg-slate-800/60 border border-slate-700 rounded-2xl p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="font-semibold">Local High Scores</div>
        <div className="text-xs opacity-70">(top 20)</div>
      </div>

      <div className="space-y-1 text-sm">
        {all.length === 0 && <div className="opacity-70">No scores yet.</div>}
        {all.map((e, i) => (
          <div key={i} className="flex items-center justify-between">
            <div className="opacity-80">#{i + 1}</div>
            <div className="font-semibold">{e.score}</div>
            <div className="opacity-70">{LEVELS.find((l) => l.id === e.level)?.name || e.level}</div>
            <div className="opacity-70">Acc: {typeof e.accuracy === 'number' ? `${e.accuracy}%` : "-"}</div>
            <div className="opacity-50 text-xs">{new Date(e.at).toLocaleString()}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// Optional: sanity check helper you can call from console
export function runSanityChecks() {
  const errors = [];
  if (!Array.isArray(LEVELS) || LEVELS.length === 0) errors.push("LEVELS not defined or empty");
  for (const lvl of LEVELS) {
    try {
      const sample = lvl.gen();
      if (!sample || typeof sample.prompt !== "string" || typeof sample.answer === "undefined") {
        errors.push(`Generator for ${lvl.id} returned invalid shape`);
      }
    } catch (e) {
      errors.push(`Generator for ${lvl.id} threw: ${String(e)}`);
    }
  }
  try {
    saveHighScore("below", 123, 45.6);
    const hs = getHighScores();
    if (!Array.isArray(hs) || hs.length === 0) errors.push("High scores not being saved/loaded properly");
    resetHighScores();
  } catch (e) {
    errors.push(`High score test failed: ${String(e)}`);
  }
  if (errors.length === 0) console.log("Sanity checks passed.");
  else console.error("Sanity checks:", errors);
  return errors;
}
